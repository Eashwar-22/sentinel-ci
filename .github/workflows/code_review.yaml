name: AI Code Reviewer

on:
  pull_request:
    paths:
      - '**/*.py'  # Only trigger on Python file changes
      # You can remove paths filter if you want it to run on all PRs

# We need permissions to write comments on the PR
permissions: write-all

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Important: Fetch all history for git diff to work

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          # Install CML (Continuous Machine Learning) tool
          npm install -g @dvcorg/cml

      - name: Run AI Reviewer
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}  # You must add this secret in GitHub
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Provided automatically by GitHub
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}    # CML needs this
        run: |
          python scripts/ai_reviewer.py
          
      - name: Post Review Comment
        if: always() # Run this even if the reviewer script fails (Rejected code)
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use CML to post the report
          if [ -f review_report.md ]; then
            cml comment create review_report.md
          fi
